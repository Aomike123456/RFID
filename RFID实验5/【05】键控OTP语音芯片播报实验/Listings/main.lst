C51 COMPILER V9.60.0.0   MAIN                                                              06/07/2023 12:40:30 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\main
                    -.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          /*********************************************************************
   2           * 实验名称：键控OTP语音芯片播报实验
   3           * 可配书籍：上册-《深入浅出STC8增强型51单片机进阶攻略》已经出版
   4                       下册-《深入浅出STC8增强型51单片机实战攻略》还在写作
   5           * 书籍备注：龙顺宇编著 清华大学出版社出版
   6           * 淘宝店铺：https://520mcu.taobao.com/
   7           * 实验平台：思修电子工作室SX-RFID-B低频ID识别与应用开发板 Long
   8           * 芯片型号：STC8G1K08/17（微调后可移植至STC8A/F/C/G/H系列单片机）
   9           * 时钟说明：芯片内部11.0592MHz，在使用STC-ISP软件时需要先配置
  10                       然后下载到单片机使得时钟配置生效。
  11           * 实验说明：用USB线插入到Uart-USB接口给开发板供电，做好STC-ISP配置并
  12           下载程序，按下K1按键后语音芯片播报“滴，欢迎使用思修电子射频识别开发
  13           板”，按下K2按键后语音芯片播报“滴，刷卡成功，十位卡号为：2022123456”，
  14           以此学习OTP语音芯片操作方法及驱动程序的编写。
  15          *********************************************************************/
  16          #include  "STC8H.h"       //主控芯片的头文件
  17          #include  "intrins.h"     //因为要用到nop()函数故而包含此文件
  18          /***************************常用数据类型定义*************************/
  19          #define u8  uint8_t
  20          #define u16 uint16_t
  21          #define u32 uint32_t
  22          typedef unsigned char  uint8_t;
  23          typedef unsigned int   uint16_t;
  24          typedef unsigned long  uint32_t;
  25          /***************************端口/引脚定义区域************************/
  26          sbit KEY1=P3^4;           //按键1 
  27          sbit KEY2=P3^3;           //按键2
  28          sbit ROTP=P1^7;           //OTP语音芯片复位脚
  29          sbit DATA=P1^5;           //OTP语音芯片数据脚
  30          sbit BUSY=P1^4;           //OTP语音芯片判忙脚
  31          /***************************用户自定义数据区域***********************/
  32          /*1:不放内容，2:滴（音效），3:错误提示音（音效），4:欢迎使用思修
  33          电子射频识别开发板，5:模拟门禁模式，6:模拟公交模式，7:刷卡成功，
  34          8:十位卡号为，9:八位卡号为，10:0，11:1，12:2，13:3，14:4，15:5，
  35          16:6，17:7，18:8，19:9，20:管理卡，21:用户卡，22:学生卡，23:老年
  36          卡，24:卡片有效，解锁成功，25:卡片非法，解锁失败，26:按键，27:识
  37          别成功，28:扣费成功，29:免费乘车*/
  38          /*****************************函数声明区域***************************/
  39          void delay(u16 Count);    //延时函数
  40          void Delay150us(void);    //150us延时函数
  41          void IO_init(void);       //IO初始化函数
  42          void KEY_Prosser(void);   //按键处理函数
  43          void TTS(u8 num);         //OTP语音合成函数
  44          /******************************主函数区域****************************/
  45          void main(void)
  46          {
  47   1        IO_init();              //IO初始化
  48   1        while(1)  
  49   1        {
  50   2          KEY_Prosser();        //按键处理
  51   2        }
  52   1      }
  53          /********************************************************************/
  54          //延时函数delay()，有形参Count用于控制延时函数执行次数，无返回值
C51 COMPILER V9.60.0.0   MAIN                                                              06/07/2023 12:40:30 PAGE 2   

  55          /********************************************************************/
  56          void delay(u16 Count)
  57          {
  58   1        u8 i,j;
  59   1        while(Count--)
  60   1        {
  61   2          for(i=0;i<50;i++)
  62   2            for(j=0;j<20;j++);
  63   2        }
  64   1      }
  65          /********************************************************************/
  66          //150us延时函数Delay150us()，无形参，无返回值，这是用STC-ISP算出
  67          //来的150us延时，此延时可以不严格，但应大于50us小于200us
  68          /********************************************************************/
  69          void Delay150us(void)//@11.0592MHz
  70          {
  71   1        u8 i,j;
  72   1        _nop_();
  73   1        _nop_();
  74   1        i=3;
  75   1        j=36;
  76   1        do
  77   1        {
  78   2          while(--j);
  79   2        } while(--i);
  80   1      }
  81          /********************************************************************/
  82          //IO初始化函数IO_Init()，无形参，无返回值
  83          /********************************************************************/
  84          void IO_init(void)
  85          {
  86   1        //配置P3.3-4为准双向/弱上拉模式
  87   1        P3M0&=0xE7;     //P3M0.3-4=0
  88   1        P3M1&=0xE7;     //P3M1.3-4=0
  89   1        //配置P1.4为准双向/弱上拉模式
  90   1        P1M0&=0xEF;     //P1M0.4=0
  91   1        P1M1&=0xEF;     //P1M1.4=0
  92   1        //配置P1.5为推挽输出模式
  93   1        P1M0|=0x20;     //P1M0.5=1
  94   1        P1M1&=0xDF;     //P1M1.5=0
  95   1        //配置P1.7为推挽输出模式
  96   1        P1M0|=0x80;     //P1M0.7=1
  97   1        P1M1&=0x7F;     //P1M1.7=0
  98   1        delay(10);      //等待I/O模式配置稳定
  99   1        ROTP=1;         //拉高复位引脚
 100   1        DATA=1;         //拉高数据引脚
 101   1      }
 102          /********************************************************************/
 103          //按键处理函数KEY_Prosser(),无形参，无返回值
 104          /********************************************************************/
 105          /*1:不放内容，2:滴（音效），3:错误提示音（音效），4:欢迎使用思修
 106          电子射频识别开发板，5:模拟门禁模式，6:模拟公交模式，7:刷卡成功，
 107          8:十位卡号为，9:八位卡号为，10:0，11:1，12:2，13:3，14:4，15:5，
 108          16:6，17:7，18:8，19:9，20:管理卡，21:用户卡，22:学生卡，23:老年
 109          卡，24:卡片有效，解锁成功，25:卡片非法，解锁失败，26:按键，27:识
 110          别成功，28:扣费成功，29:免费乘车*/
 111          /********************************************************************/
 112          void KEY_Prosser(void)
 113          {
 114   1        if(KEY1==0)     //KEY1按下了
 115   1        {
 116   2          delay(5);     //软件延时“消抖”
C51 COMPILER V9.60.0.0   MAIN                                                              06/07/2023 12:40:30 PAGE 3   

 117   2          if(KEY1==0)   //KEY1确实按下了
 118   2          {
 119   3            //合成语音“滴，欢迎使用思修电子射频识别开发板”
 120   3            TTS(1);while(!BUSY);    //播报1段并等待完成（无内容）
 121   3            TTS(2);while(!BUSY);    //播报2段并等待完成（滴）
 122   3            TTS(4);while(!BUSY);    //播报9段并等待完成（欢迎使用思修电子射频识别开发板）
 123   3          }
 124   2          while(!KEY1); //松手检测
 125   2        }
 126   1        if(KEY2==0)     //KEY2按下了
 127   1        {
 128   2          delay(5);     //软件延时“消抖”
 129   2          if(KEY2==0)   //KEY2确实按下了
 130   2          {
 131   3            //合成语音“滴，刷卡成功，十位卡号为：2022123456”
 132   3            TTS(1);while(!BUSY);    //播报1段并等待完成（无内容）
 133   3            TTS(2);while(!BUSY);    //播报2段并等待完成（滴）
 134   3            TTS(7);while(!BUSY);    //播报7段并等待完成（刷卡成功）
 135   3            TTS(8);while(!BUSY);    //播报8段并等待完成（十位卡号为）
 136   3            TTS(12);while(!BUSY);   //播报12段并等待完成（2）
 137   3            TTS(10);while(!BUSY);   //播报10段并等待完成（0）
 138   3            TTS(12);while(!BUSY);   //播报12段并等待完成（2）
 139   3            TTS(12);while(!BUSY);   //播报12段并等待完成（2）
 140   3            TTS(11);while(!BUSY);   //播报11段并等待完成（1）
 141   3            TTS(12);while(!BUSY);   //播报12段并等待完成（2）
 142   3            TTS(13);while(!BUSY);   //播报13段并等待完成（3）
 143   3            TTS(14);while(!BUSY);   //播报14段并等待完成（4）
 144   3            TTS(15);while(!BUSY);   //播报15段并等待完成（5）
 145   3            TTS(16);while(!BUSY);   //播报16段并等待完成（6）
 146   3          }
 147   2          while(!KEY2); //松手检测
 148   2        } 
 149   1      }
 150          /********************************************************************/
 151          //OTP语音合成函数TTS_Prosser(),无形参，无返回值
 152          /********************************************************************/
 153          void TTS(u8 num)
 154          {
 155   1        ROTP=1;         //拉高复位引脚
 156   1        Delay150us();   //保持150us
 157   1        ROTP=0;         //拉低复位引脚
 158   1        Delay150us();   //保持150us
 159   1        ROTP=1;         //拉高复位引脚
 160   1        Delay150us();   //保持150us
 161   1        ROTP=0;         //拉低复位引脚
 162   1        Delay150us();   //保持150us
 163   1        while(num>0)    //若选定播放段地址不为0，则正常播报
 164   1        {
 165   2          DATA=1;       //拉高数据引脚
 166   2          Delay150us(); //保持150us
 167   2          DATA=0;       //拉高数据引脚
 168   2          Delay150us(); //保持150us
 169   2          num--;        //发出num个脉冲指定要播报的段
 170   2        }
 171   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    307    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
C51 COMPILER V9.60.0.0   MAIN                                                              06/07/2023 12:40:30 PAGE 4   

   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
